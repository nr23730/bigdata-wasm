<!DOCTYPE html>
<html>
<head>
    <title>BigData WebAssembly</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script type="text/javascript" src="lib/require.js"></script>
</head>
<body>
<div id="inputs" style="float:left;">
<textarea id="code" style="width:250px;height:200px">
fun main(mul : Int) : Int {
   var a : Int
   a = 4
   var b : Int = 6
   var c : Boolean = 1
   var d : Int = 0
   if(c != 0) {
      d = a+b*mul
   } else {
      d = 0
   }
   return d
}

</textarea>
    <br/>
    <button id="parse">compile + execute</button>
    <br/>
    Note: The default value handed to the function is 10. So the expected result for the given example is 64.<br/>
    You can also use other values using the console built into your browser by calling "$ main(10)".
</div>
<div id="outputs" style="float:left">
    <div id="wat" style="float:left;margin-left:10px"></div>
    <div id="wasm" style="float:left;width:400px;margin-left:10px;"></div>
</div>
<div id="result" style="clear:both"></div>
<script type="text/javascript">
    var main;

    var createWasmString = function (instructions, functionCounter, exportSection) {
        var binaryMagic = Array(
            0, 97, 115, 109, //WASM Binary Magic
            1, 0, 0, 0); //WASM Version 1.0

        //TYPE-SECTION
        var typeSection = Array(
            1, //section code
            0, //section size calculated afterwards
            1, //num types

            //type0
            96, //func
            1, //number of parameters
            127, // i32
            1, //number of return values
            127); // i32

        typeSection[1] = typeSection.length - 2; //set section length

        //FUNCTION-SECTION
        var functionSection = Array(
            3, //section code
            0, //section size calculated afterwards
            functionCounter); //number of functions
        for (i = 0; i < functionCounter; i++)
            functionSection.push(0); // function i signature index

        functionSection[1] = functionSection.length - 2;

        //CODE
        var codeSection = Array(
            10, //section code
            0, //section size calculated afterwards
            functionCounter); //number of functions

        //BODY represented by instructions

        codeSection = codeSection.concat(instructions);
        codeSection[1] = codeSection.length - 2;

        //NAME
        /*nameSection = Array(
            0, //section code
            0, //section size calculated afterwards
            4, //string length
            110,97,109,101);  //name in 0x
        functionNameType = Array(
            1, //function name type
            0, //section size calculated afterwards
            1, //number of functions
            0, //function index
            4, //string length
            109,97,105,110); //main in 0x

        functionNameType[1] = functionNameType.length-2;

        localNameType = Array(
            2, //local name type
            0, //section size calculated afterwards
            1, //number of functions
            0, //function index
            localvar + 1, //number of variables
            0, //local index
            0, //string length
            1, //local index
            0, //string length
            2, //local index
            0, //string length
            3, //local index
            0, //string length
        );

        localNameType[1] = localNameType.length-2;
        nameSection[1] = nameSection.length-2 + functionNameType.length + localNameType.length;*/
        return binaryMagic
            .concat(typeSection)
            .concat(functionSection)
            .concat(exportSection)
            .concat(codeSection);
    };


    var antlr4 = require('antlr4/index');
    var BigDataLexer = require('parser/BigDataLexer');
    var BigDataParser = require('parser/BigDataParser');
    var MyListener = require('js/MyListener');
    document.getElementById("parse").addEventListener("click", function () {
        var input = document.getElementById("code").value;
        var chars = new antlr4.InputStream(input);
        var lexer = new BigDataLexer.BigDataLexer(chars);
        var tokens = new antlr4.CommonTokenStream(lexer);
        var parser = new BigDataParser.BigDataParser(tokens);
        parser.buildParseTrees = true;
        var tree = parser.input();
        var listener = new MyListener(parser);
        antlr4.tree.ParseTreeWalker.DEFAULT.walk(listener, tree);
        document.getElementById('wat').innerText = "WebAssembly-Text (WAT):\n\n" + listener.wat;
        wasm = listener.getWasm();
        console.log(wasm);
        document.getElementById('wasm').innerText = "WebAssembly-Bytecode (WASM):\n\n" + wasm;
        var wasmModule = new WebAssembly.Module(new Uint8Array(wasm));
        var wasmInstance = new WebAssembly.Instance(wasmModule);
        main = wasmInstance.exports.main;
        document.getElementById('result').innerText = "Output:\n\n" + main(10);
    });
</script>
</body>
</html>